<h1>ドライブデータ投稿</h1>
  <%= form_with model: @post, url: posts_path, method: :post do |f| %>
    <label>タイトル</label>
      <%= f.text_field :title %>
    <br />
    <label>TOP画像</label>
      <%= f.file_field :image, accept: "image/*" %>
    <br />
    <label>説明</label>
      <%= f.text_area :describe,:value =>"", id: :describe %>
    <br />
    <label>カテゴリ選択</label>
      <%= f.collection_select :category_id, Category.all, :id, :name %>
    <br />
    <label>地方選択</label>
      <%= f.select :area, Post.areas.keys.map{|k| [t("enums.post.area.#{k}"), k] } %>
    <br />
    <label>都道府県選択</label>
      <%= f.select :prefecture, Post.prefectures.keys.map{|k| [t("enums.post.prefecture.#{k}"), k] } %>
    <br />
    <label>地名</label>
      <%= f.text_field :location %>
    <br />
    <%= f.fields_for :maps do |kf| %>
    <label>緯度</label>
      <%= kf.text_field :lat, value: 0 %>
    <label>経度</label>
      <%= kf.text_field :lng, value: 0 %> 
    <%= kf.file_field :marker_image, accept: "image/*", multiple: true %>
    <br />
    <% end %>
    <label>乗り物区分</label>
      <%= f.select :vehicle, Post.vehicles.keys.map{|k| [t("enums.post.vehicle.#{k}"), k] } %>
    <br />
    <%= f.radio_button :is_deleted, :false %>
    <%= f.label :is_deleted, "公開" %> &nbsp;
    <%= f.radio_button :is_deleted, :true %>
    <%= f.label :is_deleted, "非公開" %>
    <br />
    
  
  
  <h2>Map</h2>
    <input id="address" type="textbox" placeholder="住所を入力">
    <input type="button" value="検索" onclick="codeAddress()">
    <p>赤色マーカーをドラック＆ドロップで位置の調整ができます。<br />
    右クリックで黄色マーカー<p>
    <div id='map'></div>

  <style>
    #map {
      height: 600px;
      width: 600px;
    }
  </style>

  <script>
    //初期マップの設定
    let map
    function initMap(){
      geocoder = new google.maps.Geocoder()

      map = new google.maps.Map(document.getElementById('map'), {
        center:  {lat: 35.6803997, lng:139.7690174},  //東京
        zoom: 15,
      });
    }
  
    let geocoder
    let mainmarker
    let marker 
    let maininfoWindow
    let infoWindow 
    let aft
    function codeAddress(){
    let inputAddress = document.getElementById('address').value;
      geocoder.geocode( { 'address': inputAddress}, function(results, status) {
      if (status == 'OK') {
        // trueになればマーカーを複製できないようにする
        if (aft == true){
          marker.setMap(null);
        }
        //検索時にマーカーを作成する
        map.setCenter(results[0].geometry.location);
          mainmarker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location,
            draggable: true	// ドラッグ可能にする
          });
          
          
          maininfoWindow = new google.maps.InfoWindow({
            position: results[0].geometry.location ,
            content: (document.getElementById(`post_maps_attributes_0_marker_image`))
          });
          mainmarker.addListener('click', function() { // マーカーをクリックしたとき
            maininfoWindow.open(map, mainmarker); // 吹き出しの表示
          });  
          
         //右クリックでさらにマーカーを作成
        map.addListener('rightclick', function(e){
          var marker = new google.maps.Marker({
            position: e.latLng,
            map: map,
            icon: "https://maps.google.com/mapfiles/ms/micons/yellow-dot.png",
            title: e.latLng.toString(),
            animation: google.maps.Animation.DROP
          });
          
        
          // 5回処理を繰り返す
          for(let i = 1; i < 5; i++) {
            if (document.getElementById(`post_maps_attributes_${i}_lat`).value == 0 )  {
                document.getElementById(`post_maps_attributes_${i}_lat`).value = e.latLng.lat();
                document.getElementById(`post_maps_attributes_${i}_lng`).value = e.latLng.lng(); 
                infoWindow = new google.maps.InfoWindow({
                  content:  (document.getElementById(`post_maps_attributes_${i}_marker_image`))
                }); 
                marker.addListener('click', function() { // マーカーをクリックしたとき
            　   infoWindow.open(map, marker); // 吹き出しの表示
                });  
               
            i = 5; }
            else if (document.getElementById(`post_maps_attributes_4_lat`).value != 0) {
            marker.setMap(null); }
          }
            
            //追加したマーカーの削除
            for(let i = 1; i < 5; i++){
            marker.addListener('rightclick', function(){
             if (document.getElementById(`post_maps_attributes_${i}_lat`).value == e.latLng.lat()) { 
                marker.setMap(null); 
                  document.getElementById(`post_maps_attributes_${i}_lat`).value = 0
                  document.getElementById(`post_maps_attributes_${i}_lng`).value = 0 
                } 
            });
           }
        });
          
          
          aft = true
        //検索した時に緯度経度を入力する
          document.getElementById('post_maps_attributes_0_lat').value = results[0].geometry.location.lat();
          document.getElementById('post_maps_attributes_0_lng').value = results[0].geometry.location.lng(); 
          
        // マーカーのドロップ（ドラッグ終了）時のイベント
          google.maps.event.addListener( mainmarker, 'dragend', function(ev){
            // イベントの引数evの、プロパティ.latLngが緯度経度
            document.getElementById('post_maps_attributes_0_lat').value = ev.latLng.lat();
            document.getElementById('post_maps_attributes_0_lng').value = ev.latLng.lng();
          });
      } else {
          alert('該当する結果がありませんでした：' + status);
        }
    }); 
    }
  

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API'] %>&callback=initMap" async defer></script>
  <%= f.submit "投稿" %>
<% end %>